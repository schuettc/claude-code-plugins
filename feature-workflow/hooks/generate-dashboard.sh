#!/bin/bash
# Generate DASHBOARD.md from feature directories
#
# Scans docs/features/*/  to find all features and their status based on file presence:
# - idea.md only → backlog
# - idea.md + plan.md → in-progress
# - idea.md + plan.md + shipped.md → completed
#
# Usage: generate-dashboard.sh <project_root>

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/common.sh"

PROJECT_ROOT="${1:-}"

if [[ -z "$PROJECT_ROOT" ]]; then
  echo "Usage: generate-dashboard.sh <project_root>" >&2
  exit 1
fi

FEATURES_DIR="$PROJECT_ROOT/docs/features"
DASHBOARD="$FEATURES_DIR/DASHBOARD.md"

# Ensure features directory exists
mkdir -p "$FEATURES_DIR"

# Arrays to hold features by status
declare -a BACKLOG_ITEMS=()
declare -a INPROGRESS_ITEMS=()
declare -a COMPLETED_ITEMS=()

# Parse frontmatter from a file
# Returns: name|priority|effort|impact|type|created
parse_frontmatter() {
  local file="$1"
  local name="" priority="" effort="" impact="" type="" created=""

  if [[ ! -f "$file" ]]; then
    echo "||||||"
    return
  fi

  # Extract YAML frontmatter (between --- markers)
  local in_frontmatter=false
  while IFS= read -r line; do
    if [[ "$line" == "---" ]]; then
      if [[ "$in_frontmatter" == "false" ]]; then
        in_frontmatter=true
        continue
      else
        break
      fi
    fi

    if [[ "$in_frontmatter" == "true" ]]; then
      # Parse key: value pairs
      if [[ "$line" =~ ^name:[[:space:]]*(.*)$ ]]; then
        name="${BASH_REMATCH[1]}"
      elif [[ "$line" =~ ^priority:[[:space:]]*(.*)$ ]]; then
        priority="${BASH_REMATCH[1]}"
      elif [[ "$line" =~ ^effort:[[:space:]]*(.*)$ ]]; then
        effort="${BASH_REMATCH[1]}"
      elif [[ "$line" =~ ^impact:[[:space:]]*(.*)$ ]]; then
        impact="${BASH_REMATCH[1]}"
      elif [[ "$line" =~ ^type:[[:space:]]*(.*)$ ]]; then
        type="${BASH_REMATCH[1]}"
      elif [[ "$line" =~ ^created:[[:space:]]*(.*)$ ]]; then
        created="${BASH_REMATCH[1]}"
      fi
    fi
  done < "$file"

  echo "$name|$priority|$effort|$impact|$type|$created"
}

# Get started date from plan.md frontmatter
get_started_date() {
  local file="$1"
  local started=""

  if [[ ! -f "$file" ]]; then
    echo ""
    return
  fi

  local in_frontmatter=false
  while IFS= read -r line; do
    if [[ "$line" == "---" ]]; then
      if [[ "$in_frontmatter" == "false" ]]; then
        in_frontmatter=true
        continue
      else
        break
      fi
    fi

    if [[ "$in_frontmatter" == "true" ]]; then
      if [[ "$line" =~ ^started:[[:space:]]*(.*)$ ]]; then
        started="${BASH_REMATCH[1]}"
        break
      fi
    fi
  done < "$file"

  echo "$started"
}

# Get shipped date from shipped.md frontmatter
get_shipped_date() {
  local file="$1"
  local shipped=""

  if [[ ! -f "$file" ]]; then
    echo ""
    return
  fi

  local in_frontmatter=false
  while IFS= read -r line; do
    if [[ "$line" == "---" ]]; then
      if [[ "$in_frontmatter" == "false" ]]; then
        in_frontmatter=true
        continue
      else
        break
      fi
    fi

    if [[ "$in_frontmatter" == "true" ]]; then
      if [[ "$line" =~ ^shipped:[[:space:]]*(.*)$ ]]; then
        shipped="${BASH_REMATCH[1]}"
        break
      fi
    fi
  done < "$file"

  echo "$shipped"
}

# Scan feature directories
log_info "Scanning feature directories in $FEATURES_DIR"

for feature_dir in "$FEATURES_DIR"/*/; do
  # Skip if not a directory
  [[ -d "$feature_dir" ]] || continue

  feature_id=$(basename "$feature_dir")

  # Skip DASHBOARD.md directory if somehow created
  [[ "$feature_id" == "DASHBOARD.md" ]] && continue

  idea_file="$feature_dir/idea.md"
  plan_file="$feature_dir/plan.md"
  shipped_file="$feature_dir/shipped.md"

  # Skip if no idea.md (not a valid feature)
  [[ -f "$idea_file" ]] || continue

  # Parse metadata from idea.md
  IFS='|' read -r name priority effort impact type created <<< "$(parse_frontmatter "$idea_file")"

  # Use feature_id as fallback name
  name="${name:-$feature_id}"

  # Determine status based on file presence
  if [[ -f "$shipped_file" ]]; then
    shipped_date=$(get_shipped_date "$shipped_file")
    COMPLETED_ITEMS+=("$feature_id|$name|$shipped_date")
  elif [[ -f "$plan_file" ]]; then
    started_date=$(get_started_date "$plan_file")
    INPROGRESS_ITEMS+=("$feature_id|$name|$priority|$started_date")
  else
    BACKLOG_ITEMS+=("$feature_id|$name|$priority|$effort|$created")
  fi
done

# Generate DASHBOARD.md
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")

log_info "Generating DASHBOARD.md"

cat > "$DASHBOARD" << 'HEADER'
# Feature Dashboard

*Auto-generated by hooks. Do not edit directly.*
HEADER

echo "*Last updated: $TIMESTAMP*" >> "$DASHBOARD"

# In Progress section
cat >> "$DASHBOARD" << 'EOF'

## In Progress
EOF

if [[ ${#INPROGRESS_ITEMS[@]} -eq 0 ]]; then
  echo "*No features in progress*" >> "$DASHBOARD"
else
  echo "" >> "$DASHBOARD"
  echo "| ID | Name | Priority | Started |" >> "$DASHBOARD"
  echo "|----|------|----------|---------|" >> "$DASHBOARD"

  for item in "${INPROGRESS_ITEMS[@]}"; do
    IFS='|' read -r id name priority started <<< "$item"
    echo "| [$id](./$id/) | $name | $priority | $started |" >> "$DASHBOARD"
  done
fi

# Backlog section
cat >> "$DASHBOARD" << 'EOF'

## Backlog
EOF

if [[ ${#BACKLOG_ITEMS[@]} -eq 0 ]]; then
  echo "*No features in backlog*" >> "$DASHBOARD"
else
  echo "" >> "$DASHBOARD"
  echo "| ID | Name | Priority | Effort | Added |" >> "$DASHBOARD"
  echo "|----|------|----------|--------|-------|" >> "$DASHBOARD"

  # Sort by priority (P0 first)
  for item in "${BACKLOG_ITEMS[@]}"; do
    IFS='|' read -r id name priority effort created <<< "$item"
    echo "| [$id](./$id/) | $name | $priority | $effort | $created |" >> "$DASHBOARD"
  done
fi

# Completed section
cat >> "$DASHBOARD" << 'EOF'

## Completed
EOF

if [[ ${#COMPLETED_ITEMS[@]} -eq 0 ]]; then
  echo "*No completed features*" >> "$DASHBOARD"
else
  echo "" >> "$DASHBOARD"
  echo "| ID | Name | Shipped |" >> "$DASHBOARD"
  echo "|----|------|---------|" >> "$DASHBOARD"

  for item in "${COMPLETED_ITEMS[@]}"; do
    IFS='|' read -r id name shipped <<< "$item"
    echo "| [$id](./$id/) | $name | $shipped |" >> "$DASHBOARD"
  done
fi

log_info "Dashboard generated successfully"
exit 0
